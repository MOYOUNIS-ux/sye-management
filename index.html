
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SYE Management â€” Ù†Ø¸Ø§Ù… ÙÙˆØ§ØªÙŠØ± ÙˆÙ…ØµØ±ÙˆÙØ§Øª</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22%233aa0c9%22/></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800&display=swap" rel="stylesheet">
  <!-- html2pdf for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <style>
    :root{
      --bg:#f7fbfc;
      --card:#ffffff;
      --muted:#64707a;
      --accent:#2aa6c6;
      --accent-2:#6fd1c0;
      --radius:12px;
      --shadow: 0 10px 30px rgba(17,24,39,0.06);
      --success:#16a34a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:'Tajawal',sans-serif;background:var(--bg);margin:0;color:#0b2a33;padding:28px; -webkit-font-smoothing:antialiased;}
    .wrap{max-width:1100px;margin:0 auto;animation:fadeIn 450ms ease both}
    @keyframes fadeIn{from{opacity:0; transform: translateY(6px)} to{opacity:1; transform:none}}
    header{display:flex;align-items:center;gap:16px}
    header img{height:56px;filter:drop-shadow(0 4px 12px rgba(42,166,198,0.12));border-radius:8px}
    header h1{margin:0;font-size:20px;color:#08303a}
    .muted{color:var(--muted);font-size:13px}
    nav{display:flex;gap:10px;margin-top:18px;align-items:center}
    .tab{padding:8px 14px;border-radius:999px;background:transparent;border:1px solid transparent;cursor:pointer;color:var(--muted);font-weight:700;transition:all 200ms ease}
    .tab:hover{transform:translateY(-2px)}
    .tab.active{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#fff;box-shadow:var(--shadow)}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-top:14px;transition:transform 160ms ease}
    .card:hover{transform:translateY(-4px)}
    .row{display:flex;gap:12px;align-items:center}
    .col{flex:1}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text], input[type=number], select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef2;background:transparent;color:inherit;outline:none;transition:box-shadow 120ms ease}
    input:focus, select:focus{box-shadow:0 6px 18px rgba(42,166,198,0.08);border-color:var(--accent)}
    button{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700;transition:transform 120ms ease, box-shadow 120ms ease}
    button:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(90deg,var(--accent-2),var(--accent));color:#fff;box-shadow:0 8px 24px rgba(42,166,198,0.12)}
    .btn-primary:hover{filter:brightness(1.03)}
    .btn-ghost{background:transparent;color:var(--muted);border:1px solid #e6eef2}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;text-align:right;border-bottom:1px solid #f0f4f6;font-size:14px}
    .totals{display:flex;gap:12px;justify-content:flex-end;margin-top:12px}
    .box{background:#fbfeff;padding:10px 14px;border-radius:10px;border:1px solid #eef6f8}
    footer{text-align:center;margin-top:26px;color:var(--muted);font-size:13px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,10,12,0.45);z-index:999}
    .modal .panel{width:900px;max-width:95%;background:#fff;border-radius:12px;padding:18px;direction:rtl;color:#123;animation:slideDown 280ms cubic-bezier(.2,.9,.3,1)}
    @keyframes slideDown{from{opacity:0; transform: translateY(-8px)} to{opacity:1; transform:none}}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .small{font-size:13px;color:var(--muted)}
    /* responsive */
    @media(max-width:900px){.row{flex-direction:column}.actions{flex-direction:column-reverse;align-items:stretch} header{flex-direction:column;align-items:flex-start}}
    /* subtle hover for inputs */
    .card .row.card{background:#fbfeff;padding:12px;border-radius:10px;border:1px solid #f1f6f8}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="https://syecommunity.com/wp-content/uploads/2020/12/SYE-Logo.png" alt="logo">
      <div>
        <h1>Ù†Ø¸Ø§Ù… ÙÙˆØ§ØªÙŠØ± ÙˆÙ…ØµØ±ÙˆÙØ§Øª</h1>
        <div class="muted">ÙØ§ØªØ­ - Ø¹ØµØ±ÙŠ Â· Ù…ØªØµÙ„ Ø¨Ù€ Google Sheets Â· ØªØµÙ…ÙŠÙ…: Mohamed Younis</div>
      </div>
    </header>

    <nav>
      <div class="tab active" id="tab-sales" onclick="showTab('sales')">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</div>
      <div class="tab" id="tab-expenses" onclick="showTab('expenses')">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
      <div style="flex:1"></div>
      <div class="muted">Ø§Ù„Ù†Ø³Ø®Ø©: Ù†Ù‡Ø§Ø¦ÙŠØ©</div>
    </nav>

    <!-- SALES -->
    <section id="sales" class="card" aria-labelledby="tab-sales">
      <div class="row" style="align-items:flex-end">
        <div style="width:160px">
          <label>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
          <input type="text" id="invoiceNo" readonly>
        </div>
        <div style="width:200px">
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input type="text" id="invoiceDate" readonly>
        </div>
        <div class="col">
          <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
          <input type="text" id="custName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ">
        </div>
        <div style="width:220px">
          <label>ÙˆØ§ØªØ³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† +)</label>
          <input type="text" id="custPhone" placeholder="20123XXXXXXXX">
        </div>
      </div>

      <div style="margin-top:14px" class="card">
        <h4 class="small">Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h4>
        <div id="servicesList"></div>
        <div style="margin-top:10px" class="row">
          <div style="flex:0 0 180px"><button class="btn-ghost" onclick="addServiceRow()">+ Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©</button></div>
          <div style="flex:1"></div>
        </div>

        <h4 style="margin-top:12px" class="small">Ø§Ù„ÙƒØªØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h4>
        <div id="booksList"></div>
        <div style="margin-top:10px" class="row">
          <div style="flex:0 0 180px"><button class="btn-ghost" onclick="addBookRow()">+ Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨</button></div>
        </div>

        <div style="margin-top:12px" class="row">
          <div style="width:200px">
            <label>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
            <input type="number" id="paidAmount" value="0" min="0">
          </div>
          <div class="col">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <input type="text" id="saleNotes" placeholder="Ù…Ø«Ø§Ù„: Ø®ØµÙ… / Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©">
          </div>
        </div>

        <div class="totals" style="margin-top:14px">
          <div class="box">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong id="grandTotal">0.00</strong> EGP</div>
          <div class="box">Ø§Ù„Ù…Ø³ØªØ­Ù‚: <strong id="dueAmount">0.00</strong> EGP</div>
          <div class="box">Ø§Ù„Ø²ÙŠØ§Ø¯Ø©: <strong id="overpay">0.00</strong> EGP</div>
        </div>

        <div style="margin-top:14px;display:flex;gap:8px;justify-content:flex-end">
          <button class="btn-ghost" onclick="previewInvoice()">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
          <button class="btn-primary" onclick="saveSale()">ğŸ’¾ Ø­ÙØ¸</button>
          <button class="btn-ghost" onclick="resetSale()">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>

        <div id="afterSaveSales" style="margin-top:12px;display:none;justify-content:flex-end;align-items:center;gap:8px">
          <a id="waLink" class="btn-primary" target="_blank" style="text-decoration:none;padding:10px 12px;display:inline-block">ğŸ“± Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
          <button class="btn-ghost" style="margin-left:8px" onclick="printInvoice()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn-ghost" style="margin-left:8px" onclick="downloadPDF()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF</button>
        </div>
      </div>
    </section>

    <!-- EXPENSES -->
    <section id="expenses" class="card" style="display:none" aria-labelledby="tab-expenses">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</h3>
      <div class="row" style="margin-top:12px">
        <div style="width:240px">
          <label>Ø§Ù„Ø¨Ù†Ø¯</label>
          <select id="expenseCategory"></select>
        </div>
        <div class="col">
          <label>ØªÙØ§ØµÙŠÙ„</label>
          <input type="text" id="expenseDetail" placeholder="Ù…Ø«Ø§Ù„: ÙØ§ØªÙˆØ±Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø³Ø¨ØªÙ…Ø¨Ø±">
        </div>
        <div style="width:180px">
          <label>Ø§Ù„Ù…Ø¨Ù„Øº</label>
          <input type="number" id="expenseAmount" value="0" min="0">
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div class="col">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <input type="text" id="expenseNotes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¶Ø§ÙÙŠØ©">
        </div>
        <div style="width:220px;display:flex;align-items:end;justify-content:flex-end">
          <button class="btn-primary" onclick="saveExpense()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
        </div>
      </div>

      <div id="expenseSaved" style="margin-top:12px;display:none" class="muted">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­</div>
    </section>

    <footer>
      <div class="muted">Designed by Mohamed Younis</div>
    </footer>
  </div>

  <!-- preview modal -->
  <div class="modal" id="previewModal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="panel" id="previewContent">
      <!-- invoice HTML will be injected here -->
      <div class="actions" style="margin-top:12px">
        <button class="btn-primary" onclick="confirmSaveFromPreview()">ğŸ’¾ Ø­ÙØ¸ Ùˆ Ø¥Ø±Ø³Ø§Ù„</button>
        <button class="btn-ghost" onclick="downloadPDFFromPreview()">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ PDF</button>
        <button class="btn-ghost" onclick="printPreview()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button class="btn-ghost" onclick="closePreview()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

<script>
// ----- CONFIG -----
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbztmSfxGoz64daenYanM9-_utHfglp0dE576DkguB4iVLLSbDeFrGgTsR7DG5gQ11JK/exec";
  const START_INVOICE_NUMBER = 1000;

// Services, books and expense categories
const SERVICES = [
  'Program','Conversation Program','Teens Program','Kids Program','Native Program',
  'Speaking Club (adults)','Speaking Club (kids)','Business English','Business Writing',
  'IELTS preparation','Placement test','Delay fees','SYE\\'s Certificate','Re-oral test',
  'Re-do level','Late Exam','Versant Certificate','Make up session','Mock Exam','Practice Area'
];
const BOOKS = ['Book Level 1','Book Level 2','Book Level 3','Book Level 4','Book Level 5'];
const EXP_CATS = ['ØºØ§Ø²','ÙƒÙ‡Ø±Ø¨Ø§Ø¡','Ù…ÙŠØ§Ù‡','Ø¥ÙƒØ±Ø§Ù…ÙŠØ§Øª','Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª ÙƒØªØ¨','Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª Ù…ÙˆØ¸ÙÙŠÙ†','Ù…Ø´ØªØ±ÙŠØ§Øª Ø¨ÙˆÙÙŠØ©','Ù…ØµØ±ÙˆÙØ§Øª Ø£Ø®Ø±Ù‰'];

/* ---------- UI helpers ---------- */
function showTab(tab){
  document.getElementById('sales').style.display = (tab==='sales')? 'block':'none';
  document.getElementById('expenses').style.display = (tab==='expenses')? 'block':'none';
  document.getElementById('tab-sales').classList.toggle('active', tab==='sales');
  document.getElementById('tab-expenses').classList.toggle('active', tab==='expenses');
}

/* dynamic rows */
function addServiceRow(defaultName, defaultQty=1, defaultPrice=0){
  const container = document.getElementById('servicesList');
  const wrapper = document.createElement('div');
  wrapper.className='row card';
  wrapper.style.marginTop='8px';
  wrapper.style.alignItems='center';
  wrapper.innerHTML = `
    <div style="width:350px">
      <label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
      <select class="serviceName"></select>
    </div>
    <div style="width:120px">
      <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
      <input type="number" class="serviceQty" value="${defaultQty}" min="0">
    </div>
    <div style="width:180px">
      <label>Ø§Ù„Ø³Ø¹Ø±</label>
      <input type="number" class="servicePrice" value="${defaultPrice}" min="0">
    </div>
    <div style="width:100px;display:flex;align-items:flex-end;justify-content:flex-end">
      <button class="btn-ghost" onclick="removeRow(this)">Ø­Ø°Ù</button>
    </div>
  `;
  container.appendChild(wrapper);
  const sel = wrapper.querySelector('.serviceName');
  SERVICES.forEach(s=>{const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o)});
  if(defaultName) sel.value = defaultName;
  wrapper.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', calculateTotals));
  calculateTotals();
}

function addBookRow(defaultName, defaultQty=1, defaultPrice=0){
  const container = document.getElementById('booksList');
  const wrapper = document.createElement('div');
  wrapper.className='row card';
  wrapper.style.marginTop='8px';
  wrapper.innerHTML = `
    <div style="width:350px">
      <label>Ø§Ù„ÙƒØªØ§Ø¨</label>
      <select class="bookName"></select>
    </div>
    <div style="width:120px">
      <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
      <input type="number" class="bookQty" value="${defaultQty}" min="0">
    </div>
    <div style="width:180px">
      <label>Ø§Ù„Ø³Ø¹Ø±</label>
      <input type="number" class="bookPrice" value="${defaultPrice}" min="0">
    </div>
    <div style="width:100px;display:flex;align-items:flex-end;justify-content:flex-end">
      <button class="btn-ghost" onclick="removeRow(this)">Ø­Ø°Ù</button>
    </div>
  `;
  container.appendChild(wrapper);
  const sel = wrapper.querySelector('.bookName');
  BOOKS.forEach(s=>{const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o)});
  if(defaultName) sel.value = defaultName;
  wrapper.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', calculateTotals));
  calculateTotals();
}

function removeRow(btn){
  const card = btn.closest('.card');
  card.remove();
  calculateTotals();
}

/* totals */
function calculateTotals(){
  let total = 0;
  document.querySelectorAll('#servicesList .card').forEach(c=>{
    const q = parseFloat(c.querySelector('.serviceQty').value || 0);
    const p = parseFloat(c.querySelector('.servicePrice').value || 0);
    total += q*p;
  });
  document.querySelectorAll('#booksList .card').forEach(c=>{
    const q = parseFloat(c.querySelector('.bookQty').value || 0);
    const p = parseFloat(c.querySelector('.bookPrice').value || 0);
    total += q*p;
  });
  document.getElementById('grandTotal').innerText = total.toFixed(2);
  const paid = parseFloat(document.getElementById('paidAmount').value || 0);
  const due = Math.max(0, total - paid);
  const over = Math.max(0, paid - total);
  document.getElementById('dueAmount').innerText = due.toFixed(2);
  document.getElementById('overpay').innerText = over.toFixed(2);
}

/* Preview / print / PDF helpers */
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];}); }

function buildInvoiceHTML(invoice){
  const items = invoice.items.map(it => `<tr><td style="width:60%">${escapeHtml(it.name)}</td><td style="width:15%">${it.qty}</td><td style="width:25%">${(it.qty*it.price).toFixed(2)} EGP</td></tr>`).join('');
  return `
    <div style="padding:12px;font-family:inherit;color:#123">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <img src="https://syecommunity.com/wp-content/uploads/2020/12/SYE-Logo.png" style="height:48px" />
        </div>
        <div style="text-align:left">
          <div style="font-weight:800;color:#0b3b47">Invoice / ÙØ§ØªÙˆØ±Ø©</div>
          <div class="small muted">No: ${invoice.invoiceNo}</div>
          <div class="small muted">${invoice.date}</div>
        </div>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid #eef6f8" />
      <div style="display:flex;gap:12px;justify-content:space-between">
        <div>
          <div><strong>Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${escapeHtml(invoice.customer)}</div>
          <div class="muted small">ÙˆØ§ØªØ³Ø§Ø¨: ${escapeHtml(invoice.phone || '-')}</div>
          <div class="muted small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${escapeHtml(invoice.notes || '-')}</div>
        </div>
        <div style="text-align:left">
          <div><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${invoice.total.toFixed(2)} EGP</div>
          <div class="muted small"><strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${invoice.paid.toFixed(2)} EGP</div>
          <div class="muted small"><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${invoice.due.toFixed(2)} EGP</div>
        </div>
      </div>

      <table style="margin-top:12px;width:100%;border-collapse:collapse">
        <thead>
          <tr><th style="text-align:right;padding:8px;background:#fbfeff;border:1px solid #f0f6f8">Ø§Ù„Ø®Ø¯Ù…Ø© / Ø§Ù„ÙƒØªØ§Ø¨</th><th style="padding:8px;background:#fbfeff;border:1px solid #f0f6f8">Ø§Ù„ÙƒÙ…ÙŠØ©</th><th style="padding:8px;background:#fbfeff;border:1px solid #f0f6f8">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th></tr>
        </thead>
        <tbody>${items}</tbody>
      </table>

      <div style="margin-top:18px;text-align:center;color:#8896a0">Thank you / Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§</div>
      <div style="margin-top:6px;text-align:center;color:#b3c1c7;font-size:12px">Designed by Mohamed Younis</div>
    </div>
  `;
}

function previewInvoice(){
  calculateTotals();
  const invoice = gatherInvoice(false);
  const html = buildInvoiceHTML(invoice);
  // remove previous preview nodes (except actions)
  const container = document.getElementById('previewContent');
  Array.from(container.children).forEach(ch => { if(!ch.classList.contains('actions')) ch.remove(); });
  const div = document.createElement('div');
  div.innerHTML = html;
  container.prepend(div);
  const modal = document.getElementById('previewModal');
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
}

function closePreview(){ const modal = document.getElementById('previewModal'); modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }

function printPreview(){
  const modal = document.getElementById('previewContent');
  const content = modal.querySelector('div').innerHTML;
  const w = window.open('','printWindow','width=900,height=700');
  w.document.write('<html dir="rtl"><head><meta charset="utf-8"><title>Print</title></head><body>'+content+'</body></html>');
  w.document.close();
  w.focus();
  setTimeout(()=>{ w.print(); }, 500);
}

function downloadPDFFromPreview(){
  const modal = document.getElementById('previewContent');
  const content = modal.querySelector('div').innerHTML;
  const el = document.createElement('div'); el.innerHTML = content; document.body.appendChild(el);
  const opt = { margin:0.4, filename: 'invoice.pdf', image:{ type:'jpeg', quality:0.98 }, html2canvas:{ scale:2 }, jsPDF:{unit:'in',format:'a4',orientation:'portrait'} };
  html2pdf().set(opt).from(el).save().then(()=>el.remove());
}

/* helper to print/download from main UI */
function printInvoice(){ previewInvoice(); setTimeout(()=>printPreview(),300); }
function downloadPDF(){ previewInvoice(); setTimeout(()=>downloadPDFFromPreview(),300); }

/* gather invoice object from form */
function gatherInvoice(includeInvoiceNo=true){
  const inv = {};
  inv.invoiceNo = document.getElementById('invoiceNo').value || '';
  inv.date = document.getElementById('invoiceDate').value || new Date().toLocaleString();
  inv.customer = document.getElementById('custName').value;
  inv.phone = document.getElementById('custPhone').value;
  inv.notes = document.getElementById('saleNotes').value;
  inv.items = [];
  document.querySelectorAll('#servicesList .card').forEach(c=>{
    const name = c.querySelector('.serviceName').value;
    const qty = parseFloat(c.querySelector('.serviceQty').value||0);
    const price = parseFloat(c.querySelector('.servicePrice').value||0);
    if(qty>0 && price>=0) inv.items.push({type:'service',name,qty,price});
  });
  document.querySelectorAll('#booksList .card').forEach(c=>{
    const name = c.querySelector('.bookName').value;
    const qty = parseFloat(c.querySelector('.bookQty').value||0);
    const price = parseFloat(c.querySelector('.bookPrice').value||0);
    if(qty>0 && price>=0) inv.items.push({type:'book',name,qty,price});
  });
  inv.total = parseFloat(document.getElementById('grandTotal').innerText || 0);
  inv.paid = parseFloat(document.getElementById('paidAmount').value || 0);
  inv.due = parseFloat(document.getElementById('dueAmount').innerText || 0);
  inv.overpay = parseFloat(document.getElementById('overpay').innerText || 0);
  return inv;
}

/* ========== SAVE SALE ========== */
async function saveSale(){
  calculateTotals();
  const inv = gatherInvoice();
  if(!inv.customer){ alert('Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„'); return; }

  const payload = {
    sheet: 'Sales',
    invoiceNo: inv.invoiceNo,
    date: new Date().toISOString(),
    customer: inv.customer,
    phone: inv.phone,
    items: inv.items,
    total: inv.total,
    paid: inv.paid,
    due: inv.due,
    overpay: inv.overpay,
    notes: inv.notes
  };

  try{
    const res = await fetch(SCRIPT_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    alert(text || 'ØªÙ… Ø§Ù„Ø­ÙØ¸');
    showAfterSave(inv);
  }catch(e){
    console.error(e);
    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸. ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ Web App ÙˆÙ…Ù†Ø­ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª.');
  }
}

/* show whatsapp & export after save */
function showAfterSave(inv){
  const phone = (inv.phone || '').replace(/[^0-9]/g,'');
  const msgLines = [];
  msgLines.push(`ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† SYE ğŸ“`);
  msgLines.push(`Invoice No: #${inv.invoiceNo}`);
  msgLines.push(`Ø§Ù„Ø¹Ù…ÙŠÙ„: ${inv.customer}`);
  msgLines.push(`---`);
  inv.items.forEach(it => msgLines.push(`${it.name} x${it.qty} - ${(it.qty*it.price).toFixed(2)} EGP`));
  msgLines.push(`---`);
  msgLines.push(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${inv.total.toFixed(2)} EGP`);
  msgLines.push(`Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${inv.paid.toFixed(2)} EGP`);
  msgLines.push(`Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${inv.due.toFixed(2)} EGP`);
  msgLines.push('');
  msgLines.push('Thank you / Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§');

  const waLink = phone ? `https://wa.me/${phone}?text=${encodeURIComponent(msgLines.join('\\n'))}` : null;
  if(waLink){
    const a = document.getElementById('waLink');
    a.href = waLink;
    a.style.display='inline-block';
  }
  document.getElementById('afterSaveSales').style.display='flex';
}

/* confirm save from preview button: save then open whatsapp */
async function confirmSaveFromPreview(){
  const inv = gatherInvoice();
  await saveSale();
  const phone = (inv.phone || '').replace(/[^0-9]/g,'');
  if(phone){
    const msg = buildWhatsappMessage(inv);
    window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
  }
  closePreview();
}

/* build whatsapp message bilingual */
function buildWhatsappMessage(inv){
  const lines = [];
  lines.push(`ÙØ§ØªÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† SYE ğŸ“`);
  lines.push(`Invoice No: #${inv.invoiceNo}`);
  lines.push(`Ø§Ù„Ø¹Ù…ÙŠÙ„: ${inv.customer}`);
  lines.push('---');
  inv.items.forEach(it => lines.push(`${it.name} x${it.qty} - ${(it.qty*it.price).toFixed(2)} EGP`));
  lines.push('---');
  lines.push(`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${inv.total.toFixed(2)} EGP`);
  lines.push(`Paid: ${inv.paid.toFixed(2)} EGP`);
  lines.push(`Due: ${inv.due.toFixed(2)} EGP`);
  lines.push('');
  lines.push('Thank you / Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§');
  return lines.join('\\n');
}

/* ========== EXPENSES ========== */
function populateExpenseCats(){
  const sel = document.getElementById('expenseCategory');
  sel.innerHTML = '';
  EXP_CATS.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; sel.appendChild(o) });
}

async function saveExpense(){
  const expense = {
    sheet: 'Expenses',
    date: new Date().toISOString(),
    category: document.getElementById('expenseCategory').value,
    detail: document.getElementById('expenseDetail').value,
    amount: parseFloat(document.getElementById('expenseAmount').value || 0),
    notes: document.getElementById('expenseNotes').value
  };
  if(!expense.amount || expense.amount<=0){ alert('Ø§ÙƒØªØ¨ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }
  try{
    const res = await fetch(SCRIPT_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify(expense)
    });
    const text = await res.text();
    document.getElementById('expenseSaved').style.display='block';
    setTimeout(()=>document.getElementById('expenseSaved').style.display='none',3000);
  }catch(e){ console.error(e); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ'); }
}

/* ========== invoice numbering support ========== */
async function loadLastInvoiceNumber(){
  document.getElementById('invoiceDate').value = new Date().toLocaleString();
  try{
    const res = await fetch(SCRIPT_URL + '?action=lastInvoice');
    if(!res.ok) throw new Error('no');
    const j = await res.json();
    let last = parseInt(j.last || 0);
    if(!last || last < START_INVOICE_NUMBER) last = START_INVOICE_NUMBER;
    const next = last + 1;
    document.getElementById('invoiceNo').value = next;
  }catch(e){
    const next = START_INVOICE_NUMBER + 1;
    document.getElementById('invoiceNo').value = next;
  }
}

/* reset sale */
function resetSale(){
  document.getElementById('custName').value = '';
  document.getElementById('custPhone').value = '';
  document.getElementById('saleNotes').value = '';
  document.getElementById('paidAmount').value = 0;
  document.getElementById('servicesList').innerHTML = '';
  document.getElementById('booksList').innerHTML = '';
  addServiceRow(); addBookRow(); calculateTotals();
  document.getElementById('afterSaveSales').style.display='none';
  loadLastInvoiceNumber();
}

/* init */
function init(){
  populateExpenseCats();
  addServiceRow();
  addBookRow();
  calculateTotals();
  loadLastInvoiceNumber();
}
document.addEventListener('input', function(e){ if(['paidAmount'].includes(e.target.id)) calculateTotals(); });
init();
</script>
</body>
</html>
